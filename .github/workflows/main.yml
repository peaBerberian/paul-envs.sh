name: Main

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  pull_request:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io

      - name: Set up Docker (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install docker docker-compose
          # Note: Docker Desktop might need manual setup on macOS runners

      - name: Set up Docker (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "Docker Desktop should be pre-installed on Windows runners"
          docker --version

      - name: Create test directory
        shell: bash
        run: |
          mkdir -p test-project
          echo "# Test Project" > test-project/README.md

      - name: Test script help
        shell: bash
        run: |
          ./paul-envs.sh

      - name: Test list (empty)
        shell: bash
        run: |
          ./paul-envs.sh list

      - name: Test create with --no-prompt (minimal)
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-minimal \
            --shell bash

      - name: Test create with Node.js
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-node \
            --shell bash \
            --nodejs latest

      - name: Test create with multiple languages
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-multi-lang \
            --shell zsh \
            --nodejs latest \
            --rust latest \
            --python latest \
            --go latest

      - name: Test create with specific versions (requires mise)
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-versions \
            --shell bash \
            --nodejs 20.10.0 \
            --python 3.12.0 \
            --mise

      - name: Test create with tools
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-tools \
            --shell fish \
            --neovim \
            --starship \
            --atuin \
            --mise \
            --zellij \
            --jujutsu

      - name: Test create with WASM and sudo
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-wasm-sudo \
            --shell bash \
            --rust latest \
            --enable-wasm \
            --enable-sudo

      - name: Test create with git config
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-git \
            --shell bash \
            --git-name "Test User" \
            --git-email "test@example.com"

      - name: Test create with packages
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-packages \
            --shell bash \
            --packages "curl wget git"

      - name: Test create with ports
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-ports \
            --shell bash \
            --port 3000 \
            --port 8080

      - name: Test create with volumes
        shell: bash
        run: |
          mkdir -p test-volume-source
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-volumes \
            --shell bash \
            --volume ./test-volume-source:/data:ro

      - name: Test create with custom UID/GID (Unix only)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-uid-gid \
            --shell bash \
            --uid 1001 \
            --gid 1001

      - name: Test create with custom username
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-username \
            --shell bash \
            --username devuser

      - name: Test create full configuration
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name test-full \
            --shell zsh \
            --nodejs 20.10.0 \
            --rust latest \
            --python 3.12.0 \
            --go latest \
            --enable-wasm \
            --enable-sudo \
            --neovim \
            --starship \
            --atuin \
            --mise \
            --zellij \
            --jujutsu \
            --git-name "Full Test" \
            --git-email "full@test.com" \
            --packages "ripgrep fzf" \
            --port 3000 \
            --port 5432

      - name: Test list (with projects)
        shell: bash
        run: |
          ./paul-envs.sh list

      - name: Verify project files
        shell: bash
        run: |
          test -f projects/test-minimal/compose.yaml || exit 1
          test -f projects/test-minimal/.env || exit 1
          test -f projects/test-node/compose.yaml || exit 1
          test -f projects/test-multi-lang/compose.yaml || exit 1
          echo "All project files created successfully"

      - name: Verify .env content
        shell: bash
        run: |
          grep "PROJECT_DIRNAME=" projects/test-minimal/.env || exit 1
          grep "PROJECT_PATH=" projects/test-minimal/.env || exit 1
          grep "HOST_UID=" projects/test-minimal/.env || exit 1
          grep "HOST_GID=" projects/test-minimal/.env || exit 1
          grep "USERNAME=" projects/test-minimal/.env || exit 1
          grep "USER_SHELL=" projects/test-minimal/.env || exit 1
          echo ".env file structure verified"

      - name: Verify compose.yaml structure
        shell: bash
        run: |
          grep "services:" projects/test-minimal/compose.yaml || exit 1
          grep "paulenv:" projects/test-minimal/compose.yaml || exit 1
          grep "build:" projects/test-minimal/compose.yaml || exit 1
          echo "compose.yaml structure verified"

      - name: Verify ports in compose.yaml
        shell: bash
        run: |
          grep "3000:3000" projects/test-ports/compose.yaml || exit 1
          grep "8080:8080" projects/test-ports/compose.yaml || exit 1
          echo "Ports configuration verified"

      - name: Test remove command
        shell: bash
        run: |
          echo "y" | ./paul-envs.sh remove test-minimal
          test ! -d projects/test-minimal || exit 1
          echo "Remove command verified"

      - name: Test error handling - invalid project name
        shell: bash
        run: |
          if ./paul-envs.sh create ./test-project --no-prompt --name "invalid name!" 2>/dev/null; then
            echo "Should have failed with invalid project name"
            exit 1
          fi
          echo "Invalid project name rejected correctly"

      - name: Test error handling - invalid shell
        shell: bash
        run: |
          if ./paul-envs.sh create ./test-project --no-prompt --name test-invalid-shell --shell invalidshell 2>/dev/null; then
            echo "Should have failed with invalid shell"
            exit 1
          fi
          echo "Invalid shell rejected correctly"

      - name: Test error handling - invalid version
        shell: bash
        run: |
          if ./paul-envs.sh create ./test-project --no-prompt --name test-invalid-version --nodejs "invalid.version" 2>/dev/null; then
            echo "Should have failed with invalid version"
            exit 1
          fi
          echo "Invalid version rejected correctly"

      - name: Test error handling - invalid port
        shell: bash
        run: |
          if ./paul-envs.sh create ./test-project --no-prompt --name test-invalid-port --port 99999 2>/dev/null; then
            echo "Should have failed with invalid port"
            exit 1
          fi
          echo "Invalid port rejected correctly"

      - name: Test error handling - duplicate project
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project --no-prompt --name test-duplicate --shell bash
          if ./paul-envs.sh create ./test-project --no-prompt --name test-duplicate --shell bash 2>/dev/null; then
            echo "Should have failed with duplicate project name"
            exit 1
          fi
          echo "Duplicate project name rejected correctly"

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-projects-${{ matrix.os }}
          path: projects/
          retention-days: 7

  build-and-run:
    name: Build & Run on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            platform: linux/amd64
          - os: ubuntu-latest
            arch: arm64
            platform: linux/arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Set up QEMU (for cross-platform builds)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-${{ matrix.arch }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-buildx-

      - name: Verify Docker installation
        shell: bash
        run: |
          docker --version
          docker compose version

      - name: Create test projects directory
        shell: bash
        run: |
          mkdir -p test-project
          echo "# Test Project" > test-project/README.md
          echo "echo 'Hello from test script'" > test-project/test.sh
          chmod +x test-project/test.sh

      - name: Verify base compose.yaml exists
        shell: bash
        run: |
          if [ ! -f compose.yaml ]; then
            echo "ERROR: Base compose.yaml not found"
            echo "Build tests require compose.yaml in repository root"
            exit 1
          fi
          echo "✓ Base compose.yaml found"

      - name: Create minimal build test project
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name build-minimal \
            --shell bash

          echo "✓ Created minimal project"
          ls -la projects/build-minimal/

      - name: Build minimal project
        shell: bash
        env:
          DOCKER_DEFAULT_PLATFORM: ${{ matrix.platform }}
        run: |
          echo "Building minimal project for ${{ matrix.platform }}..."
          ./paul-envs.sh build build-minimal
          echo "✓ Build completed successfully"

          echo "Verifying built image architecture..."
          ACTUAL_ARCH=$(docker images -q | head -n 1 | xargs docker image inspect --format '{{.Architecture}}')
          echo "Built architecture: $ACTUAL_ARCH"
          EXPECTED_ARCH="${{ matrix.arch }}"
          if [ "$ACTUAL_ARCH" != "$EXPECTED_ARCH" ]; then
            echo "ERROR: Expected $EXPECTED_ARCH but got $ACTUAL_ARCH"
            exit 1
          fi

      - name: Run minimal project (basic test)
        shell: bash
        run: |
          echo "Running container to verify it starts..."
          set +e
          timeout 30s ./paul-envs.sh run build-minimal bash -c "echo 'Container started successfully' && whoami && pwd && uname -m"
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 124 ]; then
            echo "Command timed out (expected for interactive sessions)"
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: Container failed to start with exit code $EXIT_CODE"
            exit 1
          fi
          echo "✓ Minimal container test passed"

      - name: Create project with Node.js
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name build-node \
            --shell bash \
            --nodejs latest

      - name: Build Node.js project
        shell: bash
        env:
          DOCKER_DEFAULT_PLATFORM: ${{ matrix.platform }}
        run: |
          echo "Building Node.js project..."
          ./paul-envs.sh build build-node
          echo "✓ Node.js build completed"

      - name: Test Node.js installation
        shell: bash
        run: |
          echo "Verifying Node.js is installed..."
          set +e
          timeout 30s ./paul-envs.sh run build-node bash -c "node --version && npm --version"
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 124 ]; then
            echo "Command timed out"
            exit 1
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: Node.js verification failed with exit code $EXIT_CODE"
            exit 1
          fi
          echo "✓ Node.js verification passed"

      - name: Test project workspace access
        shell: bash
        run: |
          echo "Testing file access in mounted project..."
          set +e
          timeout 30s ./paul-envs.sh run build-minimal bash -c "
            cd ~/projects/* || exit 1
            ls -la
            test -f README.md && echo '✓ Can read project files' || { echo '✗ Cannot read files'; exit 1; }
            test -f test.sh && echo '✓ test.sh found' || { echo '✗ test.sh not found'; exit 1; }
            ./test.sh || exit 1
          "
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 124 ]; then
            echo "Command timed out"
            exit 1
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: Workspace access test failed with exit code $EXIT_CODE"
            exit 1
          fi
          echo "✓ Workspace access test passed"

      - name: Clean up Docker resources
        if: always()
        run: |
          echo "Cleaning up Docker containers and images..."
          docker compose -f compose.yaml down --remove-orphans 2>/dev/null || true
          docker system prune -f --volumes 2>/dev/null || true

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            projects/
            *.log
          retention-days: 7

  full-build:
    name: Full Build on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            platform: linux/amd64
          - os: ubuntu-latest
            arch: arm64
            platform: linux/arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Set up QEMU (for cross-platform builds on Linux)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-${{ matrix.arch }}-buildx-full-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-buildx-full-
            ${{ runner.os }}-${{ matrix.arch }}-buildx-

      - name: Create test project
        shell: bash
        run: |
          mkdir -p test-project
          echo "# Test Project" > test-project/README.md

      - name: Create full build
        shell: bash
        run: |
          ./paul-envs.sh create ./test-project \
            --no-prompt \
            --name full-build \
            --uid 1500 \
            --gid 1500 \
            --username kitchen \
            --shell fish \
            --nodejs 20.10.0 \
            --rust 1.75.0 \
            --python 3.12.0 \
            --go 1.21.5 \
            --enable-wasm \
            --enable-sudo \
            --neovim \
            --starship \
            --atuin \
            --mise \
            --zellij \
            --jujutsu \
            --git-name "Kitchen Sink" \
            --git-email "sink@kitchen.com" \
            --packages "ripgrep fzf bat htop" \
            --port 3000 \
            --port 8080

      - name: Build full build
        shell: bash
        env:
          DOCKER_DEFAULT_PLATFORM: ${{ matrix.platform }}
        run: |
          echo "Building full build for ${{ matrix.platform }}..."
          ./paul-envs.sh build full-build
          echo "✓ Full build completed"

          echo "Verifying built image architecture..."
          ACTUAL_ARCH=$(docker images -q | head -n 1 | xargs docker image inspect --format '{{.Architecture}}')
          echo "Built architecture: $ACTUAL_ARCH"
          EXPECTED_ARCH="${{ matrix.arch }}"
          if [ "$ACTUAL_ARCH" != "$EXPECTED_ARCH" ]; then
            echo "ERROR: Expected $EXPECTED_ARCH but got $ACTUAL_ARCH"
            exit 1
          fi

      - name: Test full build
        shell: bash
        run: |
          echo "Verifying tools are installed on ${{ matrix.arch }}..."

          # First, test that fish shell loads without errors by capturing stderr
          echo "Testing fish shell initialization..."
          set +e
          FISH_OUTPUT=$(timeout 10s ./paul-envs.sh run full-build fish -c 'echo "Fish shell loaded successfully"' 2>&1)
          FISH_EXIT=$?
          set -e

          echo "$FISH_OUTPUT"

          # Check for fish errors in output
          if echo "$FISH_OUTPUT" | grep -q "Unknown command"; then
            echo "ERROR: Fish shell has unknown command errors during initialization"
            exit 1
          fi

          if echo "$FISH_OUTPUT" | grep -qi "error"; then
            echo "ERROR: Fish shell encountered errors during initialization"
            exit 1
          fi

          if [ $FISH_EXIT -ne 0 ] && [ $FISH_EXIT -ne 124 ]; then
            echo "ERROR: Fish shell failed to initialize (exit code: $FISH_EXIT)"
            exit 1
          fi

          echo "Running tool verification tests..."
          set +e
          timeout 60s ./paul-envs.sh run full-build bash -c '
            echo "Architecture: "
            uname -m
            echo ""
            echo "Testing installations..."
            FAILED=0
            command -v git && echo "✓ Git installed" || { echo "✗ Git missing"; FAILED=1; }
            command -v bash && echo "✓ Bash installed" || { echo "✗ Bash missing"; FAILED=1; }
            command -v fish && echo "✓ Fish installed" || { echo "✗ Fish missing"; FAILED=1; }
            command -v node && echo "✓ Node.js installed" || { echo "✗ Node.js missing"; FAILED=1; }
            command -v cargo && echo "✓ Cargo installed" || { echo "✗ Cargo missing"; FAILED=1; }
            command -v rustc && echo "✓ rustc installed" || { echo "✗ rustc missing"; FAILED=1; }
            command -v python && echo "✓ Python installed" || { echo "✗ Python missing"; FAILED=1; }
            command -v go && echo "✓ Go installed" || { echo "✗ Go missing"; FAILED=1; }
            command -v wasm-opt && echo "✓ Binaryen installed" || { echo "✗ Binaryen missing"; FAILED=1; }
            command -v sudo && echo "✓ sudo installed" || { echo "✗ sudo missing"; FAILED=1; }
            command -v nvim && echo "✓ Neovim installed" || { echo "✗ Neovim missing"; FAILED=1; }
            command -v starship && echo "✓ Starship installed" || { echo "✗ Starship missing"; FAILED=1; }
            command -v atuin && echo "✓ Atuin installed" || { echo "✗ Atuin missing"; FAILED=1; }
            command -v mise && echo "✓ Mise installed" || { echo "✗ Mise missing"; FAILED=1; }
            command -v zellij && echo "✓ Zellij installed" || { echo "✗ Zellij missing"; FAILED=1; }
            command -v jujutsu && echo "✓ Jujutsu installed" || { echo "✗ Jujutsu missing"; FAILED=1; }
            echo ""
            echo "Testing versions..."
            node --version || { echo "Node version check failed"; FAILED=1; }
            rustc --version || { echo "Rust version check failed"; FAILED=1; }
            python --version || { echo "Python version check failed"; FAILED=1; }
            go version || { echo "Go version check failed"; FAILED=1; }
            echo ""
            echo "Testing mise activation in shell..."
            if command -v git >/dev/null 2>&1; then
              git --version || { echo "Git version check failed"; FAILED=1; }
            fi
            if command -v bash >/dev/null 2>&1; then
              bash --version || { echo "Bash version check failed"; FAILED=1; }
            fi
            if command -v fish >/dev/null 2>&1; then
              fish --version || { echo "fish version check failed"; FAILED=1; }
            fi
            if command -v node >/dev/null 2>&1; then
              node --version || { echo "Node.js version check failed"; FAILED=1; }
            fi
            if command -v cargo >/dev/null 2>&1; then
              cargo --version || { echo "Cargo version check failed"; FAILED=1; }
            fi
            if command -v rustc >/dev/null 2>&1; then
              rustc --version || { echo "rustc version check failed"; FAILED=1; }
            fi
            if command -v python >/dev/null 2>&1; then
              python --version || { echo "Python version check failed"; FAILED=1; }
            fi
            if command -v go >/dev/null 2>&1; then
              go version || { echo "Go version check failed"; FAILED=1; }
            fi
            if command -v wasm-opt >/dev/null 2>&1; then
              wasm-opt --version || { echo "Binaryen version check failed"; FAILED=1; }
            fi
            if command -v sudo >/dev/null 2>&1; then
              sudo --version || { echo "sudo version check failed"; FAILED=1; }
            fi
            if command -v nvim >/dev/null 2>&1; then
              nvim --version || { echo "Neovim version check failed"; FAILED=1; }
            fi
            if command -v starship >/dev/null 2>&1; then
              starship --version || { echo "Starship version check failed"; FAILED=1; }
            fi
            if command -v atuin >/dev/null 2>&1; then
              atuin --version || { echo "Atuin version check failed"; FAILED=1; }
            fi
            if command -v mise >/dev/null 2>&1; then
              mise version || { echo "Mise version check failed"; FAILED=1; }
            fi
            if command -v zellij >/dev/null 2>&1; then
              zellij --version || { echo "Zellij version check failed"; FAILED=1; }
            fi
            if command -v jj >/dev/null 2>&1; then
              jj --version || { echo "Jujutsu version check failed"; FAILED=1; }
            fi
            echo ""
            if [ $FAILED -eq 1 ]; then
              echo "❌ Some tools are missing or failed to run"
              exit 1
            else
              echo "✅ All tools verified successfully"
            fi
          '
          EXIT_CODE=$?
          set -e

          # Check if it was a timeout (exit code 124)
          if [ $EXIT_CODE -eq 124 ]; then
            echo "ERROR: Test timed out after 60 seconds"
            exit 1
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: Container failed with exit code $EXIT_CODE"
            exit 1
          fi

          echo "✓ Full build test passed"

      - name: Clean up Docker resources
        if: always()
        run: |
          echo "Cleaning up Docker containers and images..."
          docker compose -f compose.yaml down --remove-orphans 2>/dev/null || true
          docker system prune -f --volumes 2>/dev/null || true

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: full-build-logs-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            projects/
            *.log
          retention-days: 7

  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          shellcheck --version
          shellcheck -x -S warning paul-envs.sh || true
          echo ""
          echo "=== Detailed analysis ==="
          shellcheck -x paul-envs.sh
