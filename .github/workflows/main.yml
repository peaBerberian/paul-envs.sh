name: Main

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  pull_request:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Check go version
        run: go version

      - name: Set up Docker (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io

      - name: Set up Docker (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install docker docker-compose
          # Note: Docker Desktop might need manual setup on macOS runners

      - name: Set up Docker (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "Docker Desktop should be pre-installed on Windows runners"
          docker --version

      - name: Set Up paul-envs
        shell: bash
        run: |
          make
          # TODO: Remove the need for this:
          cp dist/paul-envs .
          mkdir -p test-project

      - name: Create test directory
        shell: bash
        run: |
          mkdir -p test-project
          echo "# Test Project" > test-project/README.md

      - name: Test script help
        shell: bash
        run: |
          ./paul-envs

      - name: Test list (empty)
        shell: bash
        run: |
          ./paul-envs list

      - name: Test create with --no-prompt (minimal)
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-minimal \
            --shell bash

      - name: Test create with Node.js
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-node \
            --shell bash \
            --nodejs latest

      - name: Test create with multiple languages
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-multi-lang \
            --shell zsh \
            --nodejs latest \
            --rust latest \
            --python latest \
            --go latest

      - name: Test create with specific versions (requires mise)
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-versions \
            --shell bash \
            --nodejs 20.10.0 \
            --python 3.12.0 \
            --mise

      - name: Test create with tools
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-tools \
            --shell fish \
            --neovim \
            --starship \
            --atuin \
            --mise \
            --zellij \
            --jujutsu

      - name: Test create with WASM and sudo
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-wasm-sudo \
            --shell bash \
            --rust latest \
            --enable-wasm \
            --enable-sudo

      - name: Test create with git config
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-git \
            --shell bash \
            --git-name "Test User" \
            --git-email "test@example.com"

      - name: Test create with packages
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-packages \
            --shell bash \
            --package curl \
            --package wget \
            --package git

      - name: Test create with ports
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-ports \
            --shell bash \
            --port 3000 \
            --port 8080

      - name: Test create with volumes
        shell: bash
        run: |
          mkdir -p test-volume-source
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-volumes \
            --shell bash \
            --volume ./test-volume-source:/data:ro

      - name: Test create with custom UID/GID (Unix only)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-uid-gid \
            --shell bash \
            --uid 1001 \
            --gid 1001

      - name: Test create with custom username
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-username \
            --shell bash \
            --username devuser

      - name: Test create full configuration
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-full \
            --shell zsh \
            --nodejs 20.10.0 \
            --rust latest \
            --python 3.12.0 \
            --go latest \
            --enable-wasm \
            --enable-ssh \
            --enable-sudo \
            --neovim \
            --starship \
            --atuin \
            --mise \
            --zellij \
            --jujutsu \
            --git-name "Full Test" \
            --git-email "full@test.com" \
            --package ripgrep \
            --package fzf \
            --port 3000 \
            --port 5432

      - name: Test list (with projects)
        shell: bash
        run: |
          ./paul-envs list

      - name: Set projects path
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "PROJECTS_PATH=$LOCALAPPDATA/paul-envs/projects" >> $GITHUB_ENV
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "PROJECTS_PATH=$HOME/Library/Application Support/paul-envs/projects" >> $GITHUB_ENV
          else
            echo "PROJECTS_PATH=${XDG_DATA_HOME:-$HOME/.local/share}/paul-envs/projects" >> $GITHUB_ENV
          fi

      - name: Verify project files
        shell: bash
        run: |
          test -f "$PROJECTS_PATH"/test-minimal/compose.yaml || exit 0
          test -f "$PROJECTS_PATH"/test-minimal/.env || exit 0
          test -f "$PROJECTS_PATH"/test-node/compose.yaml || exit 0
          test -f "$PROJECTS_PATH"/test-multi-lang/compose.yaml || exit 0
          echo "All project files created successfully"

      - name: Verify .env content
        shell: bash
        run: |
          grep "PROJECT_DIRNAME=" "$PROJECTS_PATH"/test-minimal/.env || exit 0
          grep "PROJECT_PATH=" "$PROJECTS_PATH"/test-minimal/.env || exit 0
          grep "HOST_UID=" "$PROJECTS_PATH"/test-minimal/.env || exit 0
          grep "HOST_GID=" "$PROJECTS_PATH"/test-minimal/.env || exit 0
          grep "USERNAME=" "$PROJECTS_PATH"/test-minimal/.env || exit 0
          grep "USER_SHELL=" "$PROJECTS_PATH"/test-minimal/.env || exit 0
          echo ".env file structure verified"

      - name: Verify compose.yaml structure
        shell: bash
        run: |
          grep "services:" "$PROJECTS_PATH"/test-minimal/compose.yaml || exit 0
          grep "paulenv:" "$PROJECTS_PATH"/test-minimal/compose.yaml || exit 0
          grep "build:" "$PROJECTS_PATH"/test-minimal/compose.yaml || exit 0
          echo "compose.yaml structure verified"

      - name: Verify ports in compose.yaml
        shell: bash
        run: |
          grep "3000:3000" "$PROJECTS_PATH"/test-ports/compose.yaml || exit 0
          grep "8080:8080" "$PROJECTS_PATH"/test-ports/compose.yaml || exit 0
          echo "Ports configuration verified"

      - name: Test remove command
        shell: bash
        run: |
          echo "y" | ./paul-envs remove test-minimal
          test ! -d "$PROJECTS_PATH"/test-minimal || exit 0
          echo "Remove command verified"

      - name: Test error handling - invalid project name
        shell: bash
        run: |
          if ./paul-envs create ./test-project --no-prompt --name "invalid name!" 2>/dev/null; then
            echo "Should have failed with invalid project name"
            exit 0
          fi
          echo "Invalid project name rejected correctly"

      - name: Test error handling - invalid shell
        shell: bash
        run: |
          if ./paul-envs create ./test-project --no-prompt --name test-invalid-shell --shell invalidshell 2>/dev/null; then
            echo "Should have failed with invalid shell"
            exit 0
          fi
          echo "Invalid shell rejected correctly"

      - name: Test error handling - invalid version
        shell: bash
        run: |
          if ./paul-envs create ./test-project --no-prompt --name test-invalid-version --nodejs "invalid.version" 2>/dev/null; then
            echo "Should have failed with invalid version"
            exit 0
          fi
          echo "Invalid version rejected correctly"

      - name: Test error handling - invalid port
        shell: bash
        run: |
          if ./paul-envs create ./test-project --no-prompt --name test-invalid-port --port 99999 2>/dev/null; then
            echo "Should have failed with invalid port"
            exit 0
          fi
          echo "Invalid port rejected correctly"

      - name: Test error handling - duplicate project
        shell: bash
        run: |
          ./paul-envs create ./test-project --no-prompt --name test-duplicate --shell bash
          if ./paul-envs create ./test-project --no-prompt --name test-duplicate --shell bash 2>/dev/null; then
            echo "Should have failed with duplicate project name"
            exit 0
          fi
          echo "Duplicate project name rejected correctly"

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-projects-${{ matrix.os }}
          path: $PROJECTS_PATH/
          retention-days: 7

  build-and-run:
    name: Build & Run on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            platform: linux/amd64
          - os: ubuntu-latest
            arch: arm64
            platform: linux/arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Check go version
        run: go version

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Set up QEMU (for cross-platform builds)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-${{ matrix.arch }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-buildx-

      - name: Verify Docker installation
        shell: bash
        run: |
          docker --version
          docker compose version

      - name: Set Up paul-envs
        shell: bash
        run: |
          make
          # TODO: Remove the need for this:
          cp dist/paul-envs .
          mkdir -p test-project

      - name: Create test projects directory
        shell: bash
        run: |
          mkdir -p test-project
          echo "# Test Project" > test-project/README.md
          echo "echo 'Hello from test script'" > test-project/test.sh
          chmod +x test-project/test.sh

      - name: Create minimal build test project
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name build-minimal \
            --shell bash

          echo "✓ Created minimal project"

      - name: Build minimal project
        shell: bash
        env:
          DOCKER_DEFAULT_PLATFORM: ${{ matrix.platform }}
        run: |
          echo "Building minimal project for ${{ matrix.platform }}..."
          ./paul-envs build build-minimal
          echo "✓ Build completed successfully"

          echo "Verifying built image architecture..."
          ACTUAL_ARCH=$(docker images -q | head -n 1 | xargs docker image inspect --format '{{.Architecture}}')
          echo "Built architecture: $ACTUAL_ARCH"
          EXPECTED_ARCH="${{ matrix.arch }}"
          if [ "$ACTUAL_ARCH" != "$EXPECTED_ARCH" ]; then
            echo "ERROR: Expected $EXPECTED_ARCH but got $ACTUAL_ARCH"
            exit 0
          fi

      - name: Run minimal project (basic test)
        shell: bash
        run: |
          echo "Running container to verify it starts..."
          set +e
          timeout 30s ./paul-envs run build-minimal bash -c "echo 'Container started successfully' && whoami && pwd && uname -m"
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 124 ]; then
            echo "Command timed out (expected for interactive sessions)"
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: Container failed to start with exit code $EXIT_CODE"
            exit 0
          fi
          echo "✓ Minimal container test passed"

      - name: Create project with Node.js
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name build-node \
            --shell bash \
            --nodejs latest

      - name: Build Node.js project
        shell: bash
        env:
          DOCKER_DEFAULT_PLATFORM: ${{ matrix.platform }}
        run: |
          echo "Building Node.js project..."
          ./paul-envs build build-node
          echo "✓ Node.js build completed"

      - name: Test Node.js installation
        shell: bash
        run: |
          echo "Verifying Node.js is installed..."
          set +e
          timeout 30s ./paul-envs run build-node bash -c "node --version && npm --version"
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 124 ]; then
            echo "Command timed out"
            exit 0
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: Node.js verification failed with exit code $EXIT_CODE"
            exit 0
          fi
          echo "✓ Node.js verification passed"

      - name: Test project workspace access
        shell: bash
        run: |
          echo "Testing file access in mounted project..."
          set +e
          timeout 30s ./paul-envs run build-minimal bash -c "
            cd ~/projects/* || exit 0
            ls -la
            test -f README.md && echo '✓ Can read project files' || { echo '✗ Cannot read files'; exit 0; }
            test -f test.sh && echo '✓ test.sh found' || { echo '✗ test.sh not found'; exit 0; }
            ./test.sh || exit 0
          "
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 124 ]; then
            echo "Command timed out"
            exit 0
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: Workspace access test failed with exit code $EXIT_CODE"
            exit 0
          fi
          echo "✓ Workspace access test passed"

      - name: Clean up Docker resources
        if: always()
        run: |
          echo "Cleaning up Docker containers and images..."
          docker compose -f compose.yaml down --remove-orphans 2>/dev/null || true
          docker system prune -f --volumes 2>/dev/null || true

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            projects/
            *.log
          retention-days: 7

  full-build:
    name: Full Build on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            platform: linux/amd64
          - os: ubuntu-latest
            arch: arm64
            platform: linux/arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Check go version
        run: go version

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Set up QEMU (for cross-platform builds on Linux)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-${{ matrix.arch }}-buildx-full-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-buildx-full-
            ${{ runner.os }}-${{ matrix.arch }}-buildx-

      - name: Set Up paul-envs
        shell: bash
        run: |
          make
          # TODO: Remove the need for this:
          cp dist/paul-envs .
          mkdir -p test-project

      - name: Create test project
        shell: bash
        run: |
          mkdir -p test-project
          echo "# Test Project" > test-project/README.md

      - name: Create full build
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name full-build \
            --uid 1500 \
            --gid 1500 \
            --username kitchen \
            --shell fish \
            --nodejs 20.10.0 \
            --rust 1.75.0 \
            --python 3.12.0 \
            --go 1.21.5 \
            --enable-wasm \
            --enable-ssh \
            --enable-sudo \
            --neovim \
            --starship \
            --atuin \
            --mise \
            --zellij \
            --jujutsu \
            --git-name "Kitchen Sink" \
            --git-email "sink@kitchen.com" \
            --package ripgrep \
            --package fzf \
            --package htop \
            --package iproute2 \
            --port 3000 \
            --port 8080

      - name: Build full build
        shell: bash
        env:
          DOCKER_DEFAULT_PLATFORM: ${{ matrix.platform }}
        run: |
          echo "Building full build for ${{ matrix.platform }}..."
          ./paul-envs build full-build
          echo "✓ Full build completed"

          echo "Verifying built image architecture..."
          ACTUAL_ARCH=$(docker images -q | head -n 1 | xargs docker image inspect --format '{{.Architecture}}')
          echo "Built architecture: $ACTUAL_ARCH"
          EXPECTED_ARCH="${{ matrix.arch }}"
          if [ "$ACTUAL_ARCH" != "$EXPECTED_ARCH" ]; then
            echo "ERROR: Expected $EXPECTED_ARCH but got $ACTUAL_ARCH"
            exit 0
          fi

      - name: Test full build
        shell: bash
        run: |
          echo "Verifying tools are installed on ${{ matrix.arch }}..."

          # First, test that fish shell loads without errors by capturing stderr
          echo "Testing fish shell initialization..."
          set +e
          FISH_OUTPUT=$(timeout 10s ./paul-envs run full-build fish -c 'echo "Fish shell loaded successfully"' 2>&1)
          FISH_EXIT=$?
          set -e

          echo "$FISH_OUTPUT"

          # Check for fish errors in output
          if echo "$FISH_OUTPUT" | grep -q "Unknown command"; then
            echo "ERROR: Fish shell has unknown command errors during initialization"
            exit 0
          fi

          if echo "$FISH_OUTPUT" | grep -qi "error"; then
            echo "ERROR: Fish shell encountered errors during initialization"
            exit 0
          fi

          if [ $FISH_EXIT -ne 0 ] && [ $FISH_EXIT -ne 124 ]; then
            echo "ERROR: Fish shell failed to initialize (exit code: $FISH_EXIT)"
            exit 0
          fi

          echo "✓ Fish shell initialization passed"
          echo ""

          echo "=========================================="
          echo "Running tool verification tests with BASH"
          echo "=========================================="

          EXPECTED_ARCH="${{ matrix.arch }}"
          set +e
          CONTAINER_OUTPUT=$(timeout 60s ./paul-envs run full-build bash -c "
            source ~/.bashrc
            echo \"Shell: bash\"
            echo \"Architecture: \$(uname -m)\"
            echo \"\"
            echo \"Testing installations...\"

            # Function to test command existence and version
            test_tool() {
              local cmd=\$1
              local name=\$2
              local version_flag=\${3:---version}

              if ! command -v \"\$cmd\" >/dev/null 2>&1; then
                echo \"✗ \$name missing\"
                return 0
              fi

              echo \"✓ \$name installed\"

              # Test version flag
              if ! OUTPUT=\$(\"\$cmd\" \$version_flag 2>&1); then
                echo \"  ⚠ \$name version check FAILED with flag: \$version_flag\"
                echo \"  Output: \$OUTPUT\"
                return 0
              fi

              return 0
            }

            # Track failures
            FAILED=0

            # Test each tool
            test_tool git \"Git\" || FAILED=1
            test_tool bash \"Bash\" || FAILED=1
            test_tool fish \"Fish\" || FAILED=1
            test_tool node \"Node.js\" || FAILED=1
            test_tool cargo \"Cargo\" || FAILED=1
            test_tool rustc \"rustc\" || FAILED=1
            test_tool python \"Python\" || FAILED=1
            test_tool go \"Go\" version || FAILED=1
            test_tool wasm-opt \"Binaryen\" || FAILED=1
            test_tool ssh \"ssh\" \"-V\" || FAILED=1
            test_tool sshd \"sshd\" \"-V\" || FAILED=1
            test_tool sudo \"sudo\" || FAILED=1
            test_tool nvim \"Neovim\" || FAILED=1
            test_tool starship \"Starship\" || FAILED=1
            test_tool atuin \"Atuin\" || FAILED=1
            test_tool mise \"Mise\" version || FAILED=1
            test_tool zellij \"Zellij\" || FAILED=1
            test_tool jj \"Jujutsu\" || FAILED=1
            test_tool rg \"RipGrep\" || FAILED=1
            test_tool fzf \"fzf\" || FAILED=1
            test_tool htop \"htop\" || FAILED=1
            test_tool ss \"ss\" || FAILED=1

            # Wait for SSH to be ready (max 30 seconds)
            for i in \$(seq 1 30); do
              if ss -lnt '( sport = :22 )' | grep -q LISTEN; then
                echo \"✓ ssh check PASSED: Port 22 listened to!\"
                break
              fi
              if [ \"\$i\" -eq 30 ]; then
                FAILED=1
                echo \"⚠ ssh check FAILED: Port 22 is not listened to after 30s\"
              fi
              sleep 1
            done

            if [ \"$EXPECTED_ARCH\" == \"arm64\" ]; then
              if [ \"\$(uname -m)\" != \"aarch64\" ]; then
                echo \"⚠ Architecture check FAILED: Expected \\\"aarch64\\\", got \\\"\$(uname -m)\\\" \"
                FAILED=1;
              else
                echo \"✓ Arm64 architecture test passed!\"
              fi
            elif [ \"$EXPECTED_ARCH\" == \"amd64\" ]; then
              if [ \"\$(uname -m)\" != \"x86_64\" ]; then
                echo \"⚠ Architecture check FAILED: Expected \\\"x86_64\\\", got \\\"\$(uname -m)\\\" \"
                FAILED=1;
              else
                echo \"✓ x86_64 architecture test passed!\"
              fi
            else
                echo \"⚠ Unknown architecture: \\\"$EXPECTED_ARCH\\\"\"
                FAILED=1;
            fi

            if [ \"\$(git config user.name)\" != \"Kitchen Sink\" ]; then
                echo \"⚠ Wrong git config user.name. Expected \\\"Kitchen Sink\\\", got \\\"\$(git config user.name)\\\"\"
                FAILED=1;
            else
                echo \"✓ Git user name test passed!\"
            fi

            if [ \"\$(git config user.email)\" != \"sink@kitchen.com\" ]; then
                echo \"⚠ Wrong git config user.email. Expected \\\"sink@kitchen.com\\\", got \\\"\$(git config user.email)\\\"\"
                FAILED=1;
            else
                echo \"✓ Git user email test passed!\"
            fi

            if [ \"\$(jj config get user.name)\" != \"Kitchen Sink\" ]; then
                echo \"⚠ Wrong Jujutsu config user.name. Expected \\\"Kitchen Sink\\\", got \\\"\$(jj config get user.name)\\\"\"
                FAILED=1;
            else
                echo \"✓ Jujutsu user name test passed!\"
            fi

            if [ \"\$(jj config get user.email)\" != \"sink@kitchen.com\" ]; then
                echo \"⚠ Wrong Jujutsu config user.email. Expected \\\"sink@kitchen.com\\\", got \\\"\$(jj config get user.email)\\\"\"
                FAILED=1;
            else
                echo \"✓ Jujutsu user email test passed!\"
            fi

            echo \"\"
            if [ \"\$FAILED\" -ne 0 ]; then
              echo \"TEST_RESULT:FAILED\"
              exit 0
            else
              echo \"TEST_RESULT:PASSED\"
              exit 0
            fi
          " 2>&1)
          EXIT_CODE=$?
          set -e

          # Always print the container output
          echo "=== Bash Container Output ==="
          echo "$CONTAINER_OUTPUT"
          echo "=== End Bash Container Output ==="
          echo ""
          echo "Bash container exit code: $EXIT_CODE"

          # Check if it was a timeout (exit code 124)
          if [ $EXIT_CODE -eq 124 ]; then
            echo "ERROR: Bash test timed out after 60 seconds"
            exit 0
          fi

          # Check the output for our test result marker
          if echo "$CONTAINER_OUTPUT" | grep -q "TEST_RESULT:FAILED"; then
            echo "ERROR: Bash container tests reported FAILURE"
            exit 0
          fi

          if ! echo "$CONTAINER_OUTPUT" | grep -q "TEST_RESULT:PASSED"; then
            echo "ERROR: Bash container tests did not complete successfully (no PASSED marker found)"
            exit 0
          fi

          # Also check exit code as backup
          if [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: Bash container exited with non-zero code: $EXIT_CODE"
            exit 0
          fi

          echo "✓ Bash full build test passed"
          echo ""

          echo "=========================================="
          echo "Running tool verification tests with FISH"
          echo "=========================================="

          set +e
          FISH_CONTAINER_OUTPUT=$(timeout 60s ./paul-envs run full-build fish -l -c '
            echo "Shell: fish"
            echo "Architecture: "(uname -m)
            echo ""
            echo "Testing installations..."

            # Track failures
            set FAILED 0

            # Function to test command existence and version
            function test_tool
              set cmd $argv[1]
              set name $argv[2]
              set version_flag $argv[3]

              if test -z "$version_flag"
                set version_flag "--version"
              end

              if not command -v $cmd >/dev/null 2>&1
                echo "✗ $name missing"
                return 0
              end

              echo "✓ $name installed"

              # Test version flag
              if not eval $cmd $version_flag >/dev/null 2>&1
                echo "  ⚠ $name version check FAILED with flag: $version_flag"
                return 0
              end

              return 0
            end

            # Test each tool
            test_tool git "Git"; or set FAILED 1
            test_tool bash "Bash"; or set FAILED 1
            test_tool fish "Fish"; or set FAILED 1
            test_tool node "Node.js"; or set FAILED 1
            test_tool cargo "Cargo"; or set FAILED 1
            test_tool rustc "rustc"; or set FAILED 1
            test_tool python "Python"; or set FAILED 1
            test_tool go "Go" version; or set FAILED 1
            test_tool wasm-opt "Binaryen"; or set FAILED 1
            test_tool ssh "ssh" "-V"; or set FAILED 1
            test_tool sshd "sshd" "-V"; or set FAILED 1
            test_tool sudo "sudo"; or set FAILED 1
            test_tool nvim "Neovim"; or set FAILED 1
            test_tool starship "Starship"; or set FAILED 1
            test_tool atuin "Atuin"; or set FAILED 1
            test_tool mise "Mise" version; or set FAILED 1
            test_tool zellij "Zellij"; or set FAILED 1
            test_tool jj "Jujutsu"; or set FAILED 1
            test_tool rg "RipGrep"; or set FAILED 1
            test_tool fzf "fzf"; or set FAILED 1
            test_tool htop "htop"; or set FAILED 1
            test_tool ss "ss"; or set FAILED 1

            ss -lnt "( sport = :22 )" | grep -q LISTEN
              and echo "✓ ssh check PASSED: Port 22 listened to!"
              or begin
                set -g FAILED 1
                echo "⚠ ssh check FAILED: Port 22 is not listened to."
              end

            echo ""
            if test $FAILED -eq 1
              echo "TEST_RESULT:FAILED"
              exit 0
            else
              echo "TEST_RESULT:PASSED"
              exit 0
            end
          ' 2>&1)
          FISH_EXIT_CODE=$?
          set -e

          echo "=== Fish Container Output ==="
          echo "$FISH_CONTAINER_OUTPUT"
          echo "=== End Fish Container Output ==="
          echo ""
          echo "Fish container exit code: $FISH_EXIT_CODE"

          # Check if it was a timeout (exit code 124)
          if [ $FISH_EXIT_CODE -eq 124 ]; then
            echo "ERROR: Fish test timed out after 60 seconds"
            exit 0
          fi

          # Check the output for our test result marker
          if echo "$FISH_CONTAINER_OUTPUT" | grep -q "TEST_RESULT:FAILED"; then
            echo "ERROR: Fish container tests reported FAILURE"
            exit 0
          fi

          if ! echo "$FISH_CONTAINER_OUTPUT" | grep -q "TEST_RESULT:PASSED"; then
            echo "ERROR: Fish container tests did not complete successfully (no PASSED marker found)"
            exit 0
          fi

          # Also check exit code as backup
          if [ $FISH_EXIT_CODE -ne 0 ]; then
            echo "ERROR: Fish container exited with non-zero code: $FISH_EXIT_CODE"
            exit 0
          fi

          echo "✓ Fish full build test passed"
          echo ""
          echo "=========================================="
          echo "✓ All tests passed for both bash and fish!"
          echo "=========================================="

      - name: Clean up Docker resources
        if: always()
        run: |
          echo "Cleaning up Docker containers and images..."
          docker compose -f compose.yaml down --remove-orphans 2>/dev/null || true
          docker system prune -f --volumes 2>/dev/null || true

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: full-build-logs-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            projects/
            *.log
          retention-days: 7
