name: Edge Cases & Path Testing

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  path-handling:
    name: Path Handling - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Check go version
        run: go version

      - name: Build paul-envs
        shell: bash
        run: |
          make
          # TODO: Remove the need for this:
          cp dist/paul-envs .

      - name: Test with absolute paths
        shell: bash
        run: |
          ABS_PATH="$(pwd)/test-absolute"
          mkdir -p "$ABS_PATH"
          ./paul-envs create "$ABS_PATH" \
            --no-prompt \
            --name test-absolute-path \
            --shell bash

      - name: Test with relative paths
        shell: bash
        run: |
          mkdir -p test-relative
          ./paul-envs create ./test-relative \
            --no-prompt \
            --name test-relative-path \
            --shell bash

      - name: Test with paths containing spaces (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p "test with spaces"
          ./paul-envs create "./test with spaces" \
            --no-prompt \
            --name test-spaces \
            --shell bash

      - name: Test with nested paths
        shell: bash
        run: |
          mkdir -p nested/deep/path/to/project
          ./paul-envs create ./nested/deep/path/to/project \
            --no-prompt \
            --name test-nested \
            --shell bash

      - name: Test Windows drive letter handling (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          # Test that Windows paths are properly normalized
          mkdir -p test-windows
          WIN_PATH="C:/Users/test-windows"
          # This should work even if path doesn't exist with --no-prompt
          ./paul-envs create "$WIN_PATH" \
            --no-prompt \
            --name test-windows-path \
            --shell bash || echo "Windows path test completed"

      - name: Set projects path
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "PROJECTS_PATH=$LOCALAPPDATA/paul-envs/projects" >> $GITHUB_ENV
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "PROJECTS_PATH=$HOME/Library/Application Support/paul-envs/projects" >> $GITHUB_ENV
          else
            echo "PROJECTS_PATH=${XDG_DATA_HOME:-$HOME/.local/share}/paul-envs/projects" >> $GITHUB_ENV
          fi

      - name: Verify path normalization in .env files
        shell: bash
        run: |
          # Check that paths were properly written to .env
          cat "$PROJECTS_PATH"/test-absolute-path/.env
          grep "PROJECT_PATH=" "$PROJECTS_PATH"/test-absolute-path/.env

  validation-tests:
    name: Input Validation Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Check go version
        run: go version

      - name: Setup
        shell: bash
        run: |
          make
          # TODO: Remove the need for this:
          cp dist/paul-envs .
          mkdir -p test-project

      - name: Test invalid package names
        shell: bash
        run: |
          # Package with uppercase should fail
          if ./paul-envs create ./test-project \
            --no-prompt \
            --name test-invalid-pkg \
            --package "Invalid-Package" 2>/dev/null; then
            echo "Should reject uppercase in package names"
            exit 1
          fi
          echo "✓ Invalid package name rejected"

      - name: Test invalid git email
        shell: bash
        run: |
          if ./paul-envs create ./test-project \
            --no-prompt \
            --name test-invalid-email \
            --git-email "notanemail" 2>/dev/null; then
            echo "Should reject invalid email"
            exit 1
          fi
          echo "✓ Invalid email rejected"

      - name: Test invalid username
        shell: bash
        run: |
          # Username starting with number should fail
          if ./paul-envs create ./test-project \
            --no-prompt \
            --name test-invalid-user \
            --username "123user" 2>/dev/null; then
            echo "Should reject username starting with number"
            exit 1
          fi
          echo "✓ Invalid username rejected"

      - name: Test port boundary values
        shell: bash
        run: |
          # Port 0 should fail
          if ./paul-envs create ./test-project \
            --no-prompt \
            --name test-port-zero \
            --port 0 2>/dev/null; then
            echo "Should reject port 0"
            exit 1
          fi

          # Port 65536 should fail
          if ./paul-envs create ./test-project \
            --no-prompt \
            --name test-port-high \
            --port 65536 2>/dev/null; then
            echo "Should reject port > 65535"
            exit 1
          fi

          # Port 1 should succeed
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-port-low \
            --port 1

          # Port 65535 should succeed
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-port-max \
            --port 65535

          echo "✓ Port validation working correctly"

      - name: Test UID/GID validation
        shell: bash
        run: |
          # Negative UID should fail
          if ./paul-envs create ./test-project \
            --no-prompt \
            --name test-negative-uid \
            --uid -1 2>/dev/null; then
            echo "Should reject negative UID"
            exit 1
          fi

          # UID > 65535 should fail
          if ./paul-envs create ./test-project \
            --no-prompt \
            --name test-high-uid \
            --uid 65536 2>/dev/null; then
            echo "Should reject UID > 65535"
            exit 1
          fi

          echo "✓ UID/GID validation working correctly"

      - name: Test git name with special characters
        shell: bash
        run: |
          # Git name with quotes should fail
          if ./paul-envs create ./test-project \
            --no-prompt \
            --name test-git-quotes \
            --git-name 'Name with "quotes"' 2>/dev/null; then
            echo "Should reject git name with quotes"
            exit 1
          fi

          # Git name with newlines should fail
          if ./paul-envs create ./test-project \
            --no-prompt \
            --name test-git-newline \
            --git-name $'Name\nwith\nnewlines' 2>/dev/null; then
            echo "Should reject git name with newlines"
            exit 1
          fi

          echo "✓ Git name validation working correctly"

  combination-tests:
    name: Complex Combinations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Check go version
        run: go version

      - name: Setup
        shell: bash
        run: |
          make
          # TODO: Remove the need for this:
          cp dist/paul-envs .
          mkdir -p test-project

      - name: Set projects path
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "PROJECTS_PATH=$LOCALAPPDATA/paul-envs/projects" >> $GITHUB_ENV
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "PROJECTS_PATH=$HOME/Library/Application Support/paul-envs/projects" >> $GITHUB_ENV
          else
            echo "PROJECTS_PATH=${XDG_DATA_HOME:-$HOME/.local/share}/paul-envs/projects" >> $GITHUB_ENV
          fi

      - name: Test all languages with mise
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-all-langs \
            --nodejs 20.10.0 \
            --rust 1.75.0 \
            --python 3.12.0 \
            --go 1.21.5 \
            --mise

          # Verify mise is enabled
          grep 'INSTALL_MISE="true"' "$PROJECTS_PATH"/test-all-langs/.env

      - name: Test all tools
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-all-tools \
            --neovim \
            --starship \
            --atuin \
            --mise \
            --zellij \
            --jujutsu

          # Verify all tools are enabled
          grep 'INSTALL_NEOVIM="true"' "$PROJECTS_PATH"/test-all-tools/.env
          grep 'INSTALL_STARSHIP="true"' "$PROJECTS_PATH"/test-all-tools/.env
          grep 'INSTALL_ATUIN="true"' "$PROJECTS_PATH"/test-all-tools/.env
          grep 'INSTALL_MISE="true"' "$PROJECTS_PATH"/test-all-tools/.env
          grep 'INSTALL_ZELLIJ="true"' "$PROJECTS_PATH"/test-all-tools/.env
          grep 'INSTALL_JUJUTSU="true"' "$PROJECTS_PATH"/test-all-tools/.env

      - name: Test multiple ports
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-many-ports \
            --port 3000 \
            --port 5432 \
            --port 6379 \
            --port 8080 \
            --port 9000

          # Verify all ports in compose
          grep "3000:3000" "$PROJECTS_PATH"/test-many-ports/compose.yaml
          grep "5432:5432" "$PROJECTS_PATH"/test-many-ports/compose.yaml
          grep "6379:6379" "$PROJECTS_PATH"/test-many-ports/compose.yaml
          grep "8080:8080" "$PROJECTS_PATH"/test-many-ports/compose.yaml
          grep "9000:9000" "$PROJECTS_PATH"/test-many-ports/compose.yaml

      - name: Test multiple volumes
        shell: bash
        run: |
          mkdir -p vol1 vol2 vol3
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-many-volumes \
            --volume ./vol1:/data1:ro \
            --volume ./vol2:/data2 \
            --volume ./vol3:/data3:ro

          # Verify volumes in compose
          grep "/data1:ro" "$PROJECTS_PATH"/test-many-volumes/compose.yaml
          grep "/data2" "$PROJECTS_PATH"/test-many-volumes/compose.yaml
          grep "/data3:ro" "$PROJECTS_PATH"/test-many-volumes/compose.yaml

      - name: Test kitchen sink configuration
        shell: bash
        run: |
          ./paul-envs create ./test-project \
            --no-prompt \
            --name test-kitchen-sink \
            --uid 1500 \
            --gid 1500 \
            --username kitchen \
            --shell fish \
            --nodejs 20.10.0 \
            --rust 1.75.0 \
            --python 3.12.0 \
            --go 1.21.5 \
            --enable-wasm \
            --enable-ssh \
            --enable-sudo \
            --neovim \
            --starship \
            --atuin \
            --mise \
            --zellij \
            --jujutsu \
            --git-name "Kitchen Sink" \
            --git-email "sink@kitchen.com" \
            --package ripgrep \
            --package fzf \
            --package htop \
            --port 3000 \
            --port 8080

          # Verify critical settings
          grep 'HOST_UID="1500"' "$PROJECTS_PATH"/test-kitchen-sink/.env
          grep 'USERNAME="kitchen"' "$PROJECTS_PATH"/test-kitchen-sink/.env
          grep 'USER_SHELL="fish"' "$PROJECTS_PATH"/test-kitchen-sink/.env
          grep 'INSTALL_MISE="true"' "$PROJECTS_PATH"/test-kitchen-sink/.env
          grep 'Kitchen Sink' "$PROJECTS_PATH"/test-kitchen-sink/.env
  unit-tests:
    name: Unit tests - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Check go version
        run: go version

      - name: Run unit tests
        shell: bash
        run: |
          make test
