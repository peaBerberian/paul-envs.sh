# Compose File Version: 1.0.0
#
# "Compose file" for your project, which will be relied on when building and
# running your container alongside the `env file` in the same directory.
#
# Can be freely updated to update ports, volumes etc.

services:
  paulenv:
{{- if or .Ports .EnableSSH}}
    # Ports opened in this container
    ports:
{{- range .Ports}}
      - "{{.}}:{{.}}"
{{- end}}
{{- if .EnableSSH}}
      # To listen for ssh connections:
      - "22:22"
{{- end}}
{{- end}}

    # "Volumes" mounted in this container
    volumes:
      # Volumes from your host mounted in the container
{{- range .Volumes}}
      - {{.}}
{{- end}}
{{- if .EnableSSH}}
{{- if .SSHKeyPath}}
      - {{.SSHKeyPath}}:/etc/ssh/authorized_keys/${USERNAME:-dev}:ro
{{- else}}
      # Add your SSH public key here, for example:
      # - ~/.ssh/id_ed25519.pub:/etc/ssh/authorized_keys/${USERNAME:-dev}:ro
{{- end}}
{{- end}}
      # Mounted project
      - ${PROJECT_PATH}:/home/${USERNAME:-dev}/projects/${PROJECT_DIRNAME}

      # Persisted container volumes (see below)
      - shared-cache:/home/${USERNAME:-dev}/.container-cache
      - local-state:/home/${USERNAME:-dev}/.container-local

    # Working directory when running the container
    working_dir: /home/${USERNAME:-dev}/projects/${PROJECT_DIRNAME}

    # Build configuration - should be left as is
    build:
      context: ../..
      dockerfile: Dockerfile
      args:
        # Environment variables used by the Dockerfile. See `.env` file.
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
        USERNAME: ${USERNAME:-dev}
        USER_SHELL: ${USER_SHELL:-bash}
        INSTALL_NEOVIM: ${INSTALL_NEOVIM:-false}
        INSTALL_STARSHIP: ${INSTALL_STARSHIP:-false}
        INSTALL_ATUIN: ${INSTALL_ATUIN:-false}
        INSTALL_MISE: ${INSTALL_MISE:-false}
        INSTALL_ZELLIJ: ${INSTALL_ZELLIJ:-false}
        INSTALL_JUJUTSU: ${INSTALL_JUJUTSU:-false}
        INSTALL_NODE: ${INSTALL_NODE:-none}
        INSTALL_RUST: ${INSTALL_RUST:-none}
        INSTALL_PYTHON: ${INSTALL_PYTHON:-none}
        INSTALL_GO: ${INSTALL_GO:-none}
        ENABLE_WASM: ${ENABLE_WASM:-false}
        ENABLE_SSH: ${ENABLE_SSH:-false}
        ENABLE_SUDO: ${ENABLE_SUDO:-false}
        GIT_AUTHOR_NAME: ${GIT_AUTHOR_NAME:-}
        GIT_AUTHOR_EMAIL: ${GIT_AUTHOR_EMAIL:-}
        SUPPLEMENTARY_PACKAGES: ${SUPPLEMENTARY_PACKAGES:-}
        PROJECT_DIRNAME: ${PROJECT_DIRNAME}
        PROJECT_PATH: ${PROJECT_PATH}
        DOTFILES_DIR: ${DOTFILES_DIR:-./placeholder}
    # Supplementary important metadata - should be left as is
    image: paulenv:{{.ProjectName}}
    pull_policy: never
    stdin_open: true
    init: true
    tty: true

# Persisted container volumes information - should be left as is
volumes:
  # Cache shared by all paul-envs containers (created separately)
  shared-cache:
    name: paulenv-shared-cache
    external: true

  # Persisted local state associated only to this container
  local-state:
    name: paulenv-{{.ProjectName}}-local
